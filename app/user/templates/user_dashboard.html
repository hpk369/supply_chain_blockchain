<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    h1 { color: #333; }
    fieldset { margin-bottom: 1.5em; }
    label { display: block; margin: 0.5em 0 0.2em; }
    input[type="text"], textarea { width: 100%; padding: 0.5em; }
    button { padding: 0.5em 1em; margin-top: 0.5em; }
    .logout { float: right; }
    #response { margin-top: 1em; white-space: pre-wrap; background: #f9f9f9; padding: 1em; border: 1px solid #ddd; }
  </style>
</head>
<body>

  <a href="{{ url_for('auth.logout') }}" class="logout">Logout</a>
  <h1>Welcome, {{ username }}</h1>

  <fieldset>
    <legend>Create a New Batch</legend>
    <label for="create_batch_id">Batch ID:</label>
    <input type="text" id="create_batch_id" placeholder="e.g. BATCH-001" />

    <label for="create_details">Details (JSON):</label>
    <textarea id="create_details" rows="3" placeholder='{"Weight": "10kg", "contents": "Widgets"}'></textarea>

    <button onClick="createBatch()">Create Batch</button>
  </fieldset>

  <fieldset>
    <legend>Transfer a Batch</legend>
    <label for="transfer_batch_id">Batch ID:</label>
    <input type="text" id="transfer_batch_id" placeholder="e.g. BATCH-001" />

    <label for="transfer_to">Transfer To (username):</label>
    <input type="text" id="transfer_to" placeholder="e.g. userB" />

    <button onClick="transferBatch()">Transfer Batch</button>
  </fieldset>

  <fieldset>
    <legend>View Batch History</legend>
    <label for="history_batch_id">Batch ID:</label>
    <input type="text" id="history_batch_id" placeholder="e.g. BATCH-001" />

    <button onClick="viewHistory()">View History</button>
  </fieldset>

  <div id="response"></div>

  <script>

    const respondDiv = document.getElementById("response");
    const createUrl = "{{ url_for('user.create_batch') }}";
    const transferUrl = "{{ url_for('user.transfer_batch') }}";
    const historyUrlTemplate = "{{ url_for('user.batch_history', batch_id='__ID__') }}";

    // We send JSON wiht the fetch; Flask-Login handles session cookies automatically.
    function createBatch() {
      const batchId = document.getElementById("create_batch_id").value;
      let details = {};
      try {
        const raw = document.getElementById("create_details").value;
        details = raw ? JSON.parse(raw) : {};
      } catch (e) {
        responseDiv.textContent = "Invalid JSON in Details field.";
        return;
      }
      fetch("{{ url_for('user.create_batch') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ batch_id: batchId, details: details })
      })
      .then(res => res.json().then(data => ({ status: res.status, body: data })))
      .then(obj => {
        respondDiv.textContent = JSON.stringify(obj, null, 2);
      })
      .catch(err => {
        responseDiv.textContent = err;
      });
    }

    function transferBatch() {
      const batchId = document.getElementById("transfer_batch_id").value;
      const toUser = document.getElementById("transfer_to").value;
      fetch("{{ url_for('user.transfer_batch') }}", {
        method: "POST",
        credentials: "same-origin",
        header: { "Content-Type": "application/json" },
        body: JSON.stringify({
          batch_id: batchId,
          to: toUser 
        })
      })
      .then(res => res.json().then(data => ({ status: res.status, body: data })))
      .then(obj => {
        responseDiv.textContent = JSON.stringify(obj, null, 2);
      })
      .catch(err => {
        responseDiv.textContent = err;
      });
    }

    async function viewHistory() {
      // 1. Validate input
      const batchId = document.getElementById("history_batch_id").value.trim();
      if(!batchId) {
        responseDiv.textContent = "Please enter a Batch ID.";
        return;
      }

      // 2. Build URL
      const baseUrl = "{{ url_for('user.batch_history', batch_id='') }}";
      const url = baseUrl + encodeURIComponent(batchId);

      try {
        // 3. Fetch combined events
        const res = await fetch(url, {
          method: "GET",
          credentials: "same-origin"
        });
        if(!res.ok) {
          // Try to extract API error message
          let err = await res.json().catch(() => null);
          throw new Error(err?.message ?? `Error ${res.status}`);
        }
        const events = await res.json();
        // 4. Render timeline
        if(!Array.isArray(events) || events.length === 0) {
          responseDiv.textContent = `No history found for batch ${batchID}.`;
          return;
        }
        // Sort by block index (for blocks) and by raised_at for concerns, but assuming backend interleaves them in correct order:
        let html = `<h3>History for ${batchId}</h3><ul>`;
        events.forEach(ev => {
          if(ev.type == "block") {
            // ev will have index, timestamp, data.actor, data.action
            html += `
              <li>
                <strong>Block #${ev.index}</strong>:
                ${ev.data.action} <em>by ${ev.data.actor}</em>
                <small>at ${ev.timestamp}</small>
              </li>`;
          } else if (ev.type === "concern") {
            // ev has block_index, issue, raised_by, raised_at
            html += `
              <li style="color:darkorange">
                <strong>Concern on Block #${ev.block_index}</strong>:
                ${ev.issue} <em>raised by ${ev.raised_by}</em>
                <small>at ${ev.raised_at}</small>
              </li>`;
          }
        });
        html += '</ul>';
        responseDiv.innerHTMl = html;
      } catch(err) {
        responseDiv.textContent = `Failed to fetch history: ${err.message}`;
      }
    }
      
  </script>

</body>
</html>